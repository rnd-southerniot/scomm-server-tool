name: scomm-server-tool

networks:
  scomm:
    driver: bridge

volumes:
  pg_data:
  redis_data:
  grafana_data:

services:
  # --- Data plane ---
  mqtt:
    extends:
      file: data-plane/mqtt/docker-compose.yml
      service: mqtt
    networks: [scomm]

  # --- Control plane ---
  postgres:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: postgres
    networks: [scomm]

  redis:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: redis
    networks: [scomm]

  # --- Observability ---
  prometheus:
    extends:
      file: observability/prometheus/docker-compose.yml
      service: prometheus
    networks: [scomm]

  alertmanager:
    extends:
      file: observability/alertmanager/docker-compose.yml
      service: alertmanager
    networks: [scomm]

  grafana:
    extends:
      file: observability/grafana/docker-compose.yml
      service: grafana
    depends_on: [prometheus]
    networks: [scomm]

  node_exporter:
    image: prom/node-exporter@sha256:3ac34ce007accad95afed72149e0d2b927b7e42fd1c866149b945b84737c62c3
    # Optional: host-level metrics exporter (works best on Linux).
    # On Docker Desktop (macOS/Windows), mount propagation options can fail.
    profiles: ["host-metrics"]
    restart: unless-stopped
    command:
      - "--path.rootfs=/host"
    volumes:
      - /:/host:ro
    ports:
      - "9100:9100"
    networks: [scomm]

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter@sha256:fb96c4413985d4b23ab02b19022b3d70a86c8e0a62f41ab15ebb6f4673781a5d
    restart: unless-stopped
    entrypoint:
      - "sh"
      - "-c"
    command:
      - >
        export DATA_SOURCE_NAME="postgresql://$(cat /run/secrets/postgres_user):$(cat /run/secrets/postgres_password)@postgres:5432/$(cat /run/secrets/postgres_db)?sslmode=disable";
        exec /bin/postgres_exporter
    ports:
      - "9187:9187"
    depends_on: [postgres]
    networks: [scomm]
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db

  redis_exporter:
    image: oliver006/redis_exporter@sha256:bac9872da2b48e6eebbffb11517a5dcda59958eda51e1e4231eeb5dd516b4a5f
    restart: unless-stopped
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    depends_on: [redis]
    networks: [scomm]

  mosquitto_exporter:
    image: sapcc/mosquitto-exporter@sha256:241570341cd144c27ca0952255a2726a4964b7397bfed93a98707b32eb06858c
    restart: unless-stopped
    command:
      - "--endpoint=tcp://mqtt:1883"
    environment:
      MQTT_USER: ${MQTT_USERNAME:-}
      MQTT_PASS: ${MQTT_PASSWORD:-}
      MQTT_CLIENT_ID: ${MQTT_EXPORTER_CLIENT_ID:-mosquitto_exporter}
    ports:
      - "9234:9234"
    depends_on: [mqtt]
    networks: [scomm]

  chirpstack_explorer:
    # Optional UI for ChirpStack (from your `chirpstack-tenants-dashboard` build).
    profiles: ["explorer"]
    build:
      context: ./chirpstack-explorer
      dockerfile: Dockerfile
    image: ${CHIRPSTACK_EXPLORER_IMAGE:-chirpstack-explorer:local}
    restart: unless-stopped
    environment:
      CHIRPSTACK_BASE_URL: ${CHIRPSTACK_EXPLORER_BASE_URL:-http://localhost:8090}
      APP_USERNAME: ${CHIRPSTACK_EXPLORER_APP_USERNAME:-admin}
      CHIRPSTACK_TOKEN_FILE: /run/secrets/chirpstack_explorer_token
      APP_PASSWORD_FILE: /run/secrets/chirpstack_explorer_app_password
      SESSION_SECRET_FILE: /run/secrets/chirpstack_explorer_session_secret
      PORT: "3000"
      NODE_ENV: production
    secrets:
      - chirpstack_explorer_token
      - chirpstack_explorer_app_password
      - chirpstack_explorer_session_secret
    ports:
      - "${CHIRPSTACK_EXPLORER_BIND_ADDR:-0.0.0.0}:${CHIRPSTACK_EXPLORER_PORT:-3002}:3000"
    networks: [scomm]

secrets:
  chirpstack_explorer_token:
    file: ./secrets/chirpstack_explorer_token
  chirpstack_explorer_app_password:
    file: ./secrets/chirpstack_explorer_app_password
  chirpstack_explorer_session_secret:
    file: ./secrets/chirpstack_explorer_session_secret
  postgres_password:
    file: ./secrets/postgres_password
  postgres_user:
    file: ./secrets/postgres_user
  postgres_db:
    file: ./secrets/postgres_db
  grafana_admin_password:
    file: ./secrets/grafana_admin_password
