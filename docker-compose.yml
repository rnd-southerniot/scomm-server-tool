name: scomm-server-tool

networks:
  scomm:
    driver: bridge

volumes:
  pg_data:
  redis_data:
  grafana_data:

services:
  # --- Data plane ---
  mqtt:
    extends:
      file: data-plane/mqtt/docker-compose.yml
      service: mqtt
    networks: [scomm]

  # --- Control plane ---
  postgres:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: postgres
    networks: [scomm]

  redis:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: redis
    networks: [scomm]

  chirpstack:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: chirpstack
    depends_on: [postgres, redis, mqtt]
    networks: [scomm]

  gateway_bridge:
    extends:
      file: control-plane/chirpstack/docker-compose.yml
      service: gateway_bridge
    depends_on: [mqtt]
    networks: [scomm]

  # --- Observability ---
  prometheus:
    extends:
      file: observability/prometheus/docker-compose.yml
      service: prometheus
    networks: [scomm]

  alertmanager:
    extends:
      file: observability/alertmanager/docker-compose.yml
      service: alertmanager
    networks: [scomm]

  grafana:
    extends:
      file: observability/grafana/docker-compose.yml
      service: grafana
    depends_on: [prometheus]
    networks: [scomm]

  node_exporter:
    image: prom/node-exporter:latest
    # Optional: host-level metrics exporter (works best on Linux).
    # On Docker Desktop (macOS/Windows), mount propagation options can fail.
    profiles: ["host-metrics"]
    restart: unless-stopped
    command:
      - "--path.rootfs=/host"
    volumes:
      - /:/host:ro
    ports:
      - "9100:9100"
    networks: [scomm]

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${CS_POSTGRES_USER:-chirpstack}:${CS_POSTGRES_PASSWORD:-chirpstack}@postgres:5432/${CS_POSTGRES_DB:-chirpstack}?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on: [postgres]
    networks: [scomm]

  redis_exporter:
    image: oliver006/redis_exporter
    restart: unless-stopped
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    depends_on: [redis]
    networks: [scomm]

  mosquitto_exporter:
    image: sapcc/mosquitto-exporter
    restart: unless-stopped
    command:
      - "--endpoint=tcp://mqtt:1883"
    ports:
      - "9234:9234"
    depends_on: [mqtt]
    networks: [scomm]

  chirpstack_explorer:
    # Optional UI for ChirpStack (from your `chirpstack-tenants-dashboard` build).
    # Recommended: override image to a real registry tag for VM deployments.
    profiles: ["explorer"]
    image: ${CHIRPSTACK_EXPLORER_IMAGE:-chirpstack-tenants-dashboard-chirpstack-explorer}
    restart: unless-stopped
    environment:
      CHIRPSTACK_BASE_URL: ${CHIRPSTACK_EXPLORER_BASE_URL:-http://localhost:8090}
      CHIRPSTACK_TOKEN: ${CHIRPSTACK_EXPLORER_TOKEN:-}
      APP_USERNAME: ${CHIRPSTACK_EXPLORER_APP_USERNAME:-admin}
      APP_PASSWORD: ${CHIRPSTACK_EXPLORER_APP_PASSWORD:-}
      SESSION_SECRET: ${CHIRPSTACK_EXPLORER_SESSION_SECRET:-change-this-to-a-long-random-string}
      PORT: "3000"
      NODE_ENV: production
    ports:
      - "${CHIRPSTACK_EXPLORER_BIND_ADDR:-0.0.0.0}:${CHIRPSTACK_EXPLORER_PORT:-3002}:3000"
    networks: [scomm]
