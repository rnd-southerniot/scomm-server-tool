version: "3.9"

services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: ${CS_POSTGRES_DB:-chirpstack}
      POSTGRES_USER: ${CS_POSTGRES_USER:-chirpstack}
      POSTGRES_PASSWORD: ${CS_POSTGRES_PASSWORD:-chirpstack}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "${CS_POSTGRES_PORT:-5432}:5432"

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    ports:
      - "${CS_REDIS_PORT:-6379}:6379"

  chirpstack:
    image: chirpstack/chirpstack:4
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    environment:
      # Optional: enable structured logging
      # RUST_LOG: info
      TZ: ${TZ:-Asia/Dhaka}
    ports:
      - "${CS_HTTP_PORT:-8090}:8080"
    volumes:
      - ./config/chirpstack.toml:/etc/chirpstack/chirpstack.toml:ro

  gateway_bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Asia/Dhaka}
    ports:
      - "${CS_GWB_UDP_PORT:-1700}:1700/udp"
    volumes:
      - ./config/gateway-bridge.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro

volumes:
  pg_data:
  redis_data:
