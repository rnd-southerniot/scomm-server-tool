services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    entrypoint:
      - "sh"
      - "-c"
      - >
        export POSTGRES_DB="$(cat /run/secrets/postgres_db)";
        export POSTGRES_USER="$(cat /run/secrets/postgres_user)";
        exec docker-entrypoint.sh postgres
    secrets:
      - postgres_password
      - postgres_user
      - postgres_db
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "${CS_POSTGRES_BIND_ADDR:-0.0.0.0}:${CS_POSTGRES_PORT:-5432}:5432"

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    ports:
      - "${CS_REDIS_BIND_ADDR:-0.0.0.0}:${CS_REDIS_PORT:-6379}:6379"

  chirpstack:
    image: chirpstack/chirpstack:4
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    environment:
      # Optional: enable structured logging
      # RUST_LOG: info
      TZ: ${TZ:-Asia/Dhaka}
    ports:
      - "${CS_HTTP_BIND_ADDR:-0.0.0.0}:${CS_HTTP_PORT:-8090}:8080"
    volumes:
      - ./config/chirpstack.toml:/etc/chirpstack/chirpstack.toml:ro
    command:
      - "sh"
      - "-c"
      - >
        export CS_POSTGRES_DB="$(cat /run/secrets/postgres_db)";
        export CS_POSTGRES_USER="$(cat /run/secrets/postgres_user)";
        export CS_POSTGRES_PASSWORD="$(cat /run/secrets/postgres_password)";
        exec /usr/bin/chirpstack
    secrets:
      - postgres_password
      - postgres_user
      - postgres_db

  gateway_bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    environment:
      TZ: ${TZ:-Asia/Dhaka}
    ports:
      - "${CS_GWB_BIND_ADDR:-0.0.0.0}:${CS_GWB_UDP_PORT:-1700}:1700/udp"
    volumes:
      - ./config/gateway-bridge.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro

volumes:
  pg_data:
  redis_data:
